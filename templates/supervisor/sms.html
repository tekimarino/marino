{% extends "base.html" %}
{% set title = "SMS" %}
{% block content %}
  <h1>SMS — Zone</h1>
  <p class="muted">Campagnes limitées à ta zone.</p>

  <div class="card">
    <form method="post" class="form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="grid-2">
        <div>
          <label>Centre de vote</label>
          <select name="polling_center">
            <option value="">Tous</option>
            {% for c in centers %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Statut</label>
          <select name="status_filter">
            <option value="">Tous</option>
            {% for s in statuses %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <label><input type="checkbox" name="only_missing_voter"> Seulement ceux sans numéro d’électeur</label>

      <label>Message</label>
      <textarea name="message" rows="4" placeholder="ex. Bonjour, votre centre de vote est..."></textarea>

      <label>Date/heure programmée (ISO, optionnel)</label>
      <input name="scheduled_at" placeholder="2028-04-01T18:00:00+00:00">

      <div class="actions">
        <button class="btn primary" type="submit" name="action" value="send_now">Envoyer maintenant</button>
        <button class="btn" type="submit" name="action" value="schedule">Programmer</button>
        <button class="btn" type="submit" name="action" value="run_due">Traiter les campagnes</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Campagnes récentes</h2>
    {% if camps %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Créée</th>
              <th>Programmée</th>
              <th>Centre</th>
              <th>Statut</th>
              <th>Envoi</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            {% for c in camps %}
              <tr>
                <td class="mono">{{ (c.created_at or '')[:19].replace('T',' ') }}</td>
                <td class="mono">{{ (c.scheduled_at or '')[:19].replace('T',' ') }}</td>
                <td>{{ c.polling_center if c.polling_center else '—' }}</td>
                <td>{{ c.status }}</td>
                <td class="mono">{{ c.sent_count }}/{{ c.total_count }}</td>
                <td>{{ (c.message or '')[:80] }}{% if (c.message or '')|length > 80 %}…{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">Aucune campagne pour l’instant.</p>
    {% endif %}
  </div>
{% endblock %}
